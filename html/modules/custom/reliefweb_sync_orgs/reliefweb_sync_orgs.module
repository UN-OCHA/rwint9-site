<?php

/**
 * @file
 * Herlpers for the ReliefWeb Sync Orgs module.
 */

/**
 * Get field information definitions for organization sync sources.
 *
 * When called without a source, returns the full registry indexed by the
 * source machine name. When a $source is provided, returns only that source's
 * definition (or an empty array if it doesn't exist).
 *
 * Source definition keys:
 * - id: string (required) Source field name holding the unique identifier.
 * - name: string (required) Human readable source label.
 * - mapping: array<string,string> Map of source field => local Drupal field.
 * - search: string[] List of source field names included in generic searches.
 * - matching: array<string,string> Source field => local canonical field used
 *   for exact matching / deduplication.
 * - fuzzy: string[] Source field names eligible for fuzzy matching logic.
 * - clean: array<string,string[]> For each source field, substrings to strip
 *   from its value prior to matching (basic sanitation rules).
 */
function reliefweb_sync_orgs_field_info(string $source = ''): array {
  $field_info = [
    'hdx' => [
      'id' => 'id',
      'name' => 'HDX',
      'label_field' => 'display_name',
      'mapping' => [
        'display_name' => 'name',
      ],
      'search' => [
        'name',
        'display_name',
      ],
      'matching' => [
        'fts_id' => 'fts_id',
        'display_name' => 'name',
      ],
      'fuzzy' => [
        'display_name',
      ],
      'clean' => [
        'display_name' => [
          ' (inactive)',
        ],
      ],
    ],
    'hpc' => [
      'id' => 'org_id',
      'name' => 'HPC',
      'label_field' => 'org_name',
      'mapping' => [
        'org_name' => 'name',
      ],
      'search' => [
        'org_name',
      ],
      'matching' => [
        'org_name' => 'name',
      ],
      'fuzzy' => [
        'org_name',
      ],
    ],
    'iati' => [
      'id' => 'iati_organisation_identifier',
      'name' => 'IATI',
      'label_field' => 'publisher',
      'mapping' => [
        'publisher' => 'name',
      ],
      'search' => [
        'publisher',
      ],
      'matching' => [
        'publisher' => 'name',
      ],
      'fuzzy' => [
        'publisher',
      ],
    ],
  ];

  if (empty($source)) {
    return $field_info;
  }

  return $field_info[$source] ?? [];
}

/**
 * Return a list of unique soruces.
 */
function reliefweb_sync_orgs_sources(): array {
  $sources = [];
  foreach (reliefweb_sync_orgs_field_info() as $source => $info) {
    $sources[$source] = $info['name'];
  }

  asort($sources);
  return $sources;
}

/**
 * Return a unique list of searchable fields for all sources.
 */
function reliefweb_sync_orgs_searchable_fields(): array {
  $fields = [];
  foreach (reliefweb_sync_orgs_field_info() as $info) {
    if (isset($info['search'])) {
      $fields = array_merge($fields, $info['search']);
    }
  }

  return array_unique($fields);
}
