<?php

/**
 * @file
 * Uninstall ReliefWeb migration files.
 */

/**
 * Implements hook_schema().
 *
 * Add a table to store a mapping of new file URIs to old ones.
 */
function reliefweb_migrate_schema() {
  $schema['reliefweb_migrate_uri_mapping'] = [
    'fields' => [
      'id' => [
        'description' => 'ID (ex: file ID).',
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0,
      ],
      'new_uri' => [
        'description' => 'New URI',
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
      ],
      'old_uri' => [
        'description' => 'Old URI',
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
      ],
    ],
    'primary key' => ['new_uri'],
    'indexes' => [
      'id' => ['id'],
    ],
  ];

  return $schema;
}

/**
 * Implements hook_update_N().
 *
 * Add the uri mapping table if doesn't already exists.
 */
function reliefweb_migrate_update_9001() {
  $table = 'reliefweb_migrate_uri_mapping';
  $schema = reliefweb_migrate_schema();
  $database = \Drupal::database();

  if (isset($schema[$table]) && !$database->schema()->tableExists($table)) {
    $database->schema()->createTable($table, $schema[$table]);
  }
}

/**
 * Implements hook_uninstall().
 *
 * Uninstall the migration configuration.
 */
function reliefweb_migrate_uninstall() {
  $table = 'reliefweb_migrate_uri_mapping';
  $schema = reliefweb_migrate_schema();
  $database = \Drupal::database();

  if (isset($schema[$table]) && !$database->schema()->tableExists($table)) {
    $database->schema()->dropTable($table);
  }

  \Drupal::service('config.manager')->uninstall('module', 'reliefweb_migrate');

  drupal_flush_all_caches();
}
