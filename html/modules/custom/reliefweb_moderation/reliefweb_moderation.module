<?php

/**
 * @file
 * Theme declaration etc. for the reliefweb_moderation module.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Render\Markup;
use Drupal\Core\Session\AccountInterface;
use Drupal\reliefweb_moderation\EntityModeratedInterface;
use Drupal\reliefweb_moderation\ModerationServiceBase;

/**
 * Implements hook_theme().
 */
function reliefweb_moderation_theme() {
  $themes = [
    'reliefweb_moderation_page' => [
      'variables' => [
        // Entity list filters.
        'filters' => NULL,
        // Attributes for the filters.
        'filters_attributes' => NULL,
        // List of entities. @see reliefweb_moderation_table below.
        'list' => NULL,
        // Attributes for the list.
        'list_attributes' => NULL,
      ],
    ],
    'reliefweb_moderation_table' => [
      'variables' => [
        // Count of results per status. @see reliefweb_moderation_totals below.
        'totals' => NULL,
        // Headers for the table with the list of entities. In general it will
        // contain a header for the edit links, a header for the main entity
        // data and a header for the date, notably used for sorting.
        'headers' => [],
        // Table rows with entity information. It should contain cells as
        // describe above for the headers.
        'rows' => [],
        // Message for when there are no results.
        'empty' => '',
        // Pager.
        'pager' => NULL,
      ],
    ],
    'reliefweb_moderation_totals' => [
      'variables' => [
        // Associative array. Each item has the following keys:
        // - status: entity status
        // - label: entity status label
        // - total: number of entities with that status.
        'totals' => NULL,
      ],
    ],
    // Template for the moderation information (status, revision log message).
    'reliefweb_moderation_information' => [
      'variables' => [
        // Associative array with the moderation status value and its label.
        'status' => [],
        // Associative array with the type of message (feedback or
        // instruction), the message content and the message author.
        'message' => [],
      ],
    ],
    // Template to display a user posting right.
    'reliefweb_moderation_user_posting_right' => [
      'variables' => [
        // Wrapper attributes.
        'attributes' => NULL,
        // User posting right.
        'right' => '',
      ],
    ],
  ];
  return $themes;
}

/**
 * Implements hook_entity_access().
 */
function reliefweb_moderation_entity_access(EntityInterface $entity, $operation, AccountInterface $account) {
  $service = ModerationServiceBase::getModerationService($entity->bundle());
  if (!empty($service)) {
    return $service->entityAccess($entity, $operation, $account);
  }
  // No opinion.
  return AccessResult::neutral();
}

/**
 * Implements hook_entity_presave().
 */
function reliefweb_moderation_entity_presave(EntityInterface $entity) {
  $service = ModerationServiceBase::getModerationService($entity->bundle());
  if (!empty($service)) {
    $service->entityPresave($entity);
  }
}

/**
 * Implements hook_preprocess_page().
 *
 * Add the moderation information block to entity pages and forms.
 */
function reliefweb_moderation_preprocess_page(&$variables) {
  if (!\Drupal::currentUser()->hasPermission('access content moderation features')) {
    return;
  }

  $route_match = \Drupal::routeMatch();
  $entity = $route_match->getParameter('node') ?? $route_match->getParameter('taxonomy_term');

  // For existing revisionable and moderated entities, add the moderation
  // information at the top of the entity page/form.
  if (
      !empty($entity) &&
      $entity instanceof EntityModeratedInterface &&
      !$entity->isNew()
  ) {
    // Note: when comming back from the preview, the original revision log will
    // not be available...
    $message = $entity->getOriginalRevisionLogMessage();
    if (!empty($message)) {
      // Convert the message to markdown to generated links notably.
      // Wrap in a Markup so that the HTML is not escaped when rendered.
      $message = Markup::create(strip_tags(check_markup($message, 'markdown'), '<a><em><strong><br>'));
    }

    $element = [
      '#theme' => 'reliefweb_moderation_information',
      '#status' => [
        'value' => $entity->getModerationStatus(),
        'label' => $entity->getModerationStatusLabel(),
      ],
      '#message' => [
        'type' => $entity->getOriginalRevisionLogMessageType(),
        'content' => $message,
        'author' => $entity->getOriginalRevisionUser(),
      ],
      // Display the moderation information before the page title and local
      // tasks.
      '#weight' => -100,
      '#cache' => [
        '#tags' => [
          $entity->getEntityTypeId() . ':' . $entity->id(),
        ],
      ],
    ];

    $variables['page']['content']['moderation-information'] = $element;
  }
}
